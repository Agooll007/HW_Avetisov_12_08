Домашнее задание к занятию 12.08 - "Резервное копирование баз данных" - Емельянов Михаил
Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.

Для оформления вашего решения в GitHub можете воспользоваться шаблоном.

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

Задание 1. Резервное копирование
Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

ОТВЕТ:
1.1. В данном случае подходит полное резервное копирование (Full backup). Полное резервное копирование предполагает создание полной копии всей базы данных на определённый момент времени, например один раз в сутки. Для восстановления данных за предыдущий день достаточно развернуть последний полный бэкап, созданный в нужную дату. Такой способ является самым простым и надёжным, однако требует значительных ресурсов для хранения и выполнения.

1.2. Для этого случая подходит инкрементное резервное копирование в сочетании с полным бэкапом либо механизм Point-in-Time Recovery (PITR). Сначала создаётся полный бэкап базы данных, после чего сохраняются только изменения (инкрементные копии или журналы транзакций). При восстановлении сначала разворачивается полный бэкап, а затем применяются изменения до нужного момента времени, например за час до сбоя. Такой подход позволяет минимизировать потерю данных, но требует более сложной настройки.

1.3.* Данный кейс возможен в рамках репликации а не резервного копирования. Он реализуется с помощью репликации и механизмов высокой доступности (High Availability). В подобных системах поддерживается одна или несколько реплик базы данных, и при отказе основной базы происходит автоматическое переключение на резервную. Это позволяет обеспечить непрерывную работу сервисов и минимизировать простой.

Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Утилита pg_dump используется для создания логической резервной копии базы данных PostgreSQL. Параметр -U postgres указывает имя пользователя PostgreSQL, от имени которого выполняется подключение к базе данных. Ключ -F c задаёт формат резервной копии — custom, который поддерживает сжатие и позволяет восстанавливать данные выборочно. Параметр -b включает в резервную копию большие объекты (BLOB). Ключ -v включает подробный режим вывода, что позволяет отслеживать процесс выполнения команды. Параметр -f backup.dump указывает имя файла, в который будет сохранена резервная копия. В конце команды указывается имя базы данных mydb, для которой создаётся бэкап.

Утилита pg_restore используется для восстановления базы данных из резервной копии, созданной в формате custom. Параметр -U postgres указывает пользователя PostgreSQL, от имени которого выполняется восстановление. Ключ -d mydb задаёт базу данных, в которую будут восстановлены данные из резервной копии. Параметр -v включает подробный режим вывода информации о процессе восстановления. В конце команды указывается файл резервной копии backup.dump, из которого выполняется восстановление.

2.2.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

ОТВЕТ:
2.1. Выгрузка базы данных в специальном формате:

Для резервного копирования базы данных PostgreSQL используется утилита pg_dump. Пример команды:

pg_dump -U postgres -F c -b -v -f backup.dump mydb


Для восстановления базы данных используется утилита pg_restore. Пример команды:

pg_restore -U postgres -d mydb -v backup.dump

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как? 

Да, процесс резервного копирования и восстановления PostgreSQL можно автоматизировать.
Для этого используются планировщики задач, такие как cron, а также скрипты, которые запускают команды резервного копирования по расписанию. Кроме того, существуют специализированные инструменты (например, pgBackRest или Barman), позволяющие автоматизировать создание, хранение и восстановление резервных копий.

Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.

ОТВЕТ:
3.1. В MySQL инкрементное резервное копирование обычно реализуется с помощью бинарных логов (binlog).
Пример команды создания полного резервного копирования с началом нового бинарного лога:

mysqldump -u root -p --all-databases --flush-logs --master-data=2 > full_backup.sql

Утилита mysqldump используется для создания логической резервной копии баз данных MySQL. Параметр -u root указывает пользователя MySQL, от имени которого выполняется подключение к серверу базы данных. Ключ -p означает, что при выполнении команды будет запрошен пароль пользователя. Параметр --all-databases указывает, что резервное копирование будет выполнено для всех баз данных, находящихся на сервере MySQL.

Ключ --flush-logs принудительно выполняет ротацию логов, то есть закрывает текущий бинарный лог и начинает запись нового. Это важно для корректной организации инкрементного резервного копирования, так как после создания полного бэкапа все последующие изменения будут записываться в новый binlog.

Параметр --master-data=2 добавляет в дамп информацию о текущей позиции бинарного лога в виде закомментированной строки CHANGE MASTER TO. Это позволяет использовать данный бэкап для восстановления или настройки репликации, не нарушая текущую работу сервера.

Символ > выполняет перенаправление стандартного вывода команды в файл full_backup.sql, в который сохраняется полный резервный дамп всех баз данных.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием? 

Использование реплики даёт преимущество в случаях, когда требуется высокая доступность системы и минимальное время простоя. Реплика позволяет быстро переключиться на рабочую копию базы данных при отказе основной, а также использовать её для распределения нагрузки на чтение. При этом реплика не заменяет резервное копирование, так как логические ошибки и повреждения данных могут быть воспроизведены на всех репликах.

Ссылки на используемые ресурсы:

PostgreSQL:
https://www.postgresql.org/docs/current/backup.html

https://www.postgresql.org/docs/current/app-pgdump.html

https://www.postgresql.org/docs/current/app-pgrestore.html

MySQL:
https://dev.mysql.com/doc/refman/8.0/en/backup-and-recovery.html

https://dev.mysql.com/doc/refman/8.0/en/binary-log.html

https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html
